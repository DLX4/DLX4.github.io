# 深入浅出Mysql数据库开发、优化与管理维护

Mysql数据库里面的门道很多，实践出真知，网易技术部出了一本资料，里面干货很多，我拿来学习一下。

做一个高效的拿来主义者，现阶段很多零散的细节不值得死抠。

我就过一遍Mysql里面的门道，大致建立Mysql的技术世界观和逻辑链。

## 存储引擎

mysql的存储引擎有很多个，熟知的是MyISAM、 InnoDB。

其中Myisam是默认的存储引擎，未指定新表的存储引擎时，默认使用Myisam。

|          | Myisam | InnoDB |
| -------- | ------ | ------ |
| 存储限制 |        | 64TB   |
| 事务安全 |        | 支持   |
| 锁机制   | 表锁   | 行锁   |
| B树索引  | 支持   | 支持   |
| 哈希索引 |        | 支持   |
| 全文索引 | 支持   |        |
| 外键     |        | 支持   |
|          |        |        |
|          |        |        |

1. MyISAM：默认的 MySQL 插件式存储引擎，它是在 Web、数据仓储和其他应用环境下最常
    使用的存储引擎之一

2. InnoDB：用于事务处理应用程序，具有众多特性，包括 ACID 事务支持。


## 索引

索引用于快速找出在某个列中有一特定值的行。

不使用索引，MySQL 必须从第 1 条记录开始然后读完整个表直到找出相关的行。表越大，花费的时间越多。

注意如果你需要访问大部分行，顺序读取要快得多，因为此时我们避免磁盘搜索。



对于 MyISAM 和 InnoDB 表，前缀可以达到 1000 字节长。

**设计索引的原则**

- 搜索的索引列，不一定是所要选择的列。换句话说，最适合索引的列是出现在 WHERE 子句中的列，或连接子句中指定的列，而不是出现在 SELECT 关键字后的选择列表中的列。
- 使用惟一索引。
- 使用短索引。对于较短的键值，索引高速缓存中的块能容纳更多的键值
- 利用最左前缀。指的是多列索引。
- 不要过度索引。
- 考虑在列上进行的比较类型。索引可用于“ <”、“ < = ”、“ = ”、“ > =”、“ >”和 BETWEEN 运算，。在模式具有一个直接量前缀时，索引也用于 LIKE 运算。如果只将某个列用于其他类型的运算时（如 STRCMP( )），对其进行索引没有价值。



## 锁机制和事务控制

锁定表的语法：
LOCK TABLES

解锁语法：
UNLOCK TABLES

innodb 的存储引擎提供行级锁，支持共享锁和排他锁两种锁定模式，以及四种不同的
隔离级别。

**死锁**

InnoDB自动检测事务的死锁，并回滚一个或几个事务来防止死锁。InnoDB不能在MySQL LOCK TABLES设定表定的地方或者涉及 InnoDB之外的存储引擎设置锁定的地方检测死锁。你必须通过设定innodb_lock_wait_timeout系统变量的值来解决这些情况。

**事务控制**

MySQL通过SET AUTOCOMMIT, START TRANSACTION, COMMIT和ROLLBACK等语句支持本地事务。



## SQL优化

优化SQL的一般步骤：

1、**通过show status了解各种sql的执行频率**。了解当前数据库的应用是以插入更新为主还是以查询操作为主，以及各种类型的 SQL 大致的执行比例是多少。

Com_select 执行 select 操作的次数，一次查询只累加 1；

Com_insert 执行 insert 操作的次数，对于批量插入的 insert 操作，只累加一次；

Com_update 执行 update 操作的次数；

Com_delete 执行 delete 操作的次数；

Slow_queries 慢查询的次数

对于事务型的应用，通过 Com_commit 和 Com_rollback 可以了解事务提交和回滚的情况，对于回滚操作非常频繁的数据库，可能意味着应用编写存在问题。

2、**定位执行效率较低的 SQL 语句。**

- 可以通过慢查询日志定位那些执行效率较低的 sql 语句，用--log-slow--queries[=file_name]选项启动
- 使用 show processlist 命令查看当前 MySQL 在进行的线程，包括线程的状态，是否锁表等等，可以实时的查看 SQL 执行情况，同时对一些锁表操作进行优化。

3、**通过 explain 或者 desc 获取MySQL 如何执行 SELECT 语句的信息。**



常用优化：

**语句优化**

1、批量插入数据时

- 数据按照主键顺序排列
- 关闭唯一性校验
- 关闭自动提交

2、优化insert语句

- INSERT DELAYED 
- 将索引文件和数据文件分在不同的磁盘上存放（利用建表中的选项）；
- 当从一个文本文件装载一个表时，使用 LOAD DATA INFILE
- 使用 replace 语句代替 insert

3、优化group by语句

SELECT a, COUNT(*) FROM bar GROUP BY a **ORDER BY NULL**;

4、优化order by

在某些情况中，MySQL 可以使用一个索引来满足 ORDER BY 子句，而不需要额外的排序。

5、优化join语句

SELECT * FROM customerinfo WHERE CustomerID NOT in (SELECT CustomerID FROM salesinfo )

连接(JOIN).. 之所以更有效率一些，是因为 MySQL 不需要在内存中创建临时表来完成这个逻辑上的需要两个步骤的查询工作。

6、OR条件优化

对于 or 子句，如果要利用索引，则or 之间的每个条件列都必须用到索引；如果没有索引，则应该考虑增加索引。

7、优先

MySQL 还允许改变语句调度的优先级，它可以使来自多个客户端的查询更好地协作，这样单个客户端就不会由于锁定而等待很长时间。改变优先级还可以确保特定类型的查询被处理得更快。

查询优先还是更新优先。

。。。。

**优化数据库对象**

1、我们可以使用 PROCEDUREANALYSE()对当前已有应用的表类型的判断，该函数可以对数据表中的列的数据类型提出优化建议。

SELECT * FROMtbl_name PROCEDUREANALYSE(); 

SELECT * FROMtbl_name PROCEDUREANALYSE(16,256);

2、拆分，提高表的访问效率

纵向拆分：
纵向拆分是只按照应用访问的频度，将表中经常访问的字段和不经常访问的字段拆分成两个
表，经常访问的字段尽量是定长的，这样可以有效的提高表的查询和更新的效率。

横向拆分：
横向拆分是指按照应用的情况，有目的的将数据横向拆分成几个表或者通过分区分到多个分
区中，这样可以有效的避免 Myisam表的读取和更新导致的锁问题。





参考资料：

《深入浅出Mysql数据库开发、优化与管理维护》