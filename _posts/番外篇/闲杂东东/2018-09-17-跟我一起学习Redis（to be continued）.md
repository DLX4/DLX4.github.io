# Redis基础

### Redis简介

- 一个速度非常快的非关系数据库。
- 存储key与5种不同类型的值之间的映射。
- 可以将存储在内存的键值对数据持久化到硬盘。
- 可以使用复制特性来扩展读性能。  
- 可以使用客户端分片来扩展写性能。



通过将传统数据库的一部分数据处理任务以及存储任务交给redis来完成，可以提升网页的载入速度，并降低资源的占用量。

### redis常用的命令

不同数据类型的常用命令。

PUBLISH命令和SUBSCRIBE命令。

SORT命令。

两个事务命令。

过期时间相关命令。



### redis的基本事务

并不是关系数据库那种回滚的事务。

被MULTI命令和EXEC命令包围的所有命令会一个接一个地执行，直到所有命令都执行完为止，当一个事务执行完毕之后Redis才会处理其他客户端的命令。



### redis持久化

两种持久化方法

- 快照：将存在于某一时刻的所有数据都写入到硬盘里面。

  redis会创建子进程并将数据保存到硬盘里面。

  但是执行BGSAVE命令还是会导致停顿，当redis存储的数据比较多的时候，比如几十个G。

  停顿主要来自fork子进程的时候，创建进程时间会随着Redis进程占用的内存大小而增长。

- 只追加文件：执行写命令时将被执行的写命令复制到硬盘里面。

  AOF开着的话会使得Redis处理命令的速度受到硬盘性能的限制，机械硬盘这种情况下每秒只能处理大约200个写命令，而固态硬盘每秒大概也只能处理几万个写命令。

  可以配置成每秒AOF而不是每次AOF。

  AOF还有文件过大的问题，不加以控制的话AOF文件的体积可能会比快照文件大好几倍，这时候要考虑配置重写压缩。


### redis复制

随着负载量上升，用户可能需要使用复制特性。







持久化的原因

为了在之后重用数据

为了防止系统故障而将数据备份到一个远程位置

Redis存储的数据可能是经过长时间计算得出的，比较来自不易数据比如对日志文件进行聚合计算（相对的就是简单从一个数据库复制出来的）





# redis使用的例子

### 用redis来管理用户登录回话session

两种cookie：

- 签名cookie：用户相关信息+签名（防止篡改）

- 令牌（token）cookie：在cookie里面存储一串随机字节作为令牌，服务器可以根据令牌在数据库中查找令牌的拥有者。用户信息可以存储在关系数据库表中。除了用户登录信息还可以把用户的浏览时长和已浏览的商品信息存储到数据库里面，便于分析推荐。


大多数关系数据库在每台数据库服务器上面每秒只能插入、更新或者删除200~2000个数据行。

高速的批量插入？

目前有个web，平均情况下每秒大约1200次写入，高峰时间每秒6000次写入。

要部署10台关系型数据库？

**如何用redis优化？**

使用一个散列来存储登录cookie令牌与已登录用户之间的映射。

登录时：将用户令牌和当前时间戳加入到最近登录的有序集合里。

浏览商品时：将这个商品添加到记录这个用户最近浏览过的商品的有序集合里面，超过25个时进行修剪。

每秒至少可以记录20000件商品。

定期清理旧的会话数据，只保存最新的1000W个会话。



### 使用redis来实现购物车

比较常见的，用cookie实现购物车

- 需要解析和验证cookie确保cookie格式正确，并且是真正可购买的商品。
- 每次请求都要带着cookie。



redis实现购物车

每一个用户的购物车都是一个散列，存储了商品ID与商品订购数量之间的映射。



### 使用redis来缓存网页

动态生成网页的通常做法：使用模板语言来简化。

95%的web页面每天最多只会改变一次。

对于可以被缓存的请求，首先尝试从缓存里面取出并返回被缓存的页面，如果缓存页面不存在，那么就生成页面并将其缓存在redis中5分钟，最后再将页面返回给函数调用者。



### 使用redis来缓存数据行

以特价商品为例，特价商品的数量都是限定的，卖完即止。因此不能对整个促销页面进行缓存，房子用户看到错误的特价商品数量。但是每次都从数据库里面取出的话，又会给数据库带来巨大的压力。

编写一个持续运行的deamon，读取指定的数据行缓存到redis里面，并不定期地对这些缓存进行更新。

使用两个有序集合：

调度集合：成员为数据行的ID，分值是一个时间戳，记录应该在何时将指定的数据行缓存到redis里面。

延时有序集合：成员为数据行的ID，分值记录了指定数据行的缓存需要每隔多少秒更新一次。



### 使用redis来实现热点商品缓存

统计商品被浏览的次数，并以此来缓存用户最经常浏览的10000个商品页面。























